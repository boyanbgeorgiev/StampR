<!DOCTYPE html>
<html lang="bg">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StampR ‚Äì –í—Ä–µ–º–µ–≤–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è–≤–∞–Ω–µ</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- –ó–∞—Ä–µ–∂–¥–∞–º–µ reCAPTCHA API -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>

<body>
  <!-- Navigation -->
  <header class="header">
    <nav class="nav">
      <a href="/index.html"><button class="active">–í—Ä–µ–º–µ–≤–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è–≤–∞–Ω–µ</button></a>
      <a href="/hash_search.html"><button>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª</button></a>
      <a href="about.html"><button>–ó–∞ –Ω–∞—Å</button></a>

      <div class="dropdown" id="userDropdown">
        <button id="dropdownToggle">üë§ –ê–∫–∞—É–Ω—Ç ‚ñæ</button>
        <div class="dropdown-menu" id="dropdownMenu">
          <!-- JS injects menu -->
        </div>
      </div>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-text">
      <h1>StampR</h1>
      <p>–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —É—Å–ª—É–≥–∞—Ç–∞. –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —É—Å–ª—É–≥–∞—Ç–∞.</p>
    </div>
    <div class="hero-icon">
      <img src="timestamp.svg" alt="–ò–∫–æ–Ω–∞ –Ω–∞ –ø–µ—á–∞—Ç" />
    </div>
  </section>

  <!-- Upload Section -->
  <section class="upload-section">
    <h2><span class="emoji">üßæ</span> –í—Ä–µ–º–µ–≤–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è–≤–∞–Ω–µ</h2>
    <div class="layout-wrapper">
      <div class="upload-card justify-center">
        <div class="upload-box original" data-label="–û—Ä–∏–≥–∏–Ω–∞–ª">
          <div class="file-input-wrapper">
            <label for="fileInput">–ö–∞—á–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª</label>
            <span id="fileName">–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω</span>
            <input type="file" id="fileInput" />
          </div>

          <!-- Checkbox –∑–∞ –ø—É–±–ª–∏—á–Ω–æ –ø–æ–∫–∞–∑–≤–∞–Ω–µ —Å –µ—Ç–∏–∫–µ—Ç –∑–∞ –º–∞–∫—Å–∏–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä -->
          <label>
            <input type="checkbox" id="publicCheckbox" /> –ó–∞–ø–∞–∑–∏ –∑–∞ –ø—É–±–ª–∏—á–Ω–æ –ø–æ–∫–∞–∑–≤–∞–Ω–µ <span id="maxFileSizeLabel"></span>
          </label>

          <!-- reCAPTCHA widget -->
          <div class="g-recaptcha" data-sitekey="6LdguQQrAAAAAGpftJEG4h_lhUjXK_AbBFFpemt-"></div>

          <button id="uploadButton">–£–¥–æ—Å—Ç–æ–≤–µ—Ä–∏</button>
        </div>
      </div>

      <!-- –°–µ–∫—Ü–∏—è –∑–∞ —Å—Ç–∞—Ç—É—Å -->
      <div id="status" class="status-info"></div>

      <!-- –°–µ–∫—Ü–∏—è –∑–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç -->
      <div id="timestampResult" class="result-card hidden">
        <h3>–†–µ–∑—É–ª—Ç–∞—Ç</h3>
        <div class="result-row">
          <label>Timestamp</label>
          <div class="result-value copy-wrap">
            <span id="resultTimestamp"></span>
            <button class="copy-btn" data-copy="resultTimestamp" title="–ö–æ–ø–∏—Ä–∞–π">üìã</button>
          </div>
        </div>

        <div class="result-row">
          <label>HASH number</label>
          <div class="result-value copy-wrap">
            <span id="resultHash" class="mono"></span>
            <button class="copy-btn" data-copy="resultHash" title="–ö–æ–ø–∏—Ä–∞–π">üìã</button>
          </div>
        </div>

        <div class="result-row">
          <label>Serial number</label>
          <div class="result-value copy-wrap">
            <span id="resultSerial"></span>
            <button class="copy-btn" data-copy="resultSerial" title="–ö–æ–ø–∏—Ä–∞–π">üìã</button>
          </div>
        </div>

        <!-- –§–æ—Ä–º—É–ª—è—Ä –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ —Å–∫—Ä–∏—Ç–∏ –ø–æ–ª–µ—Ç–∞ -->
        <form method="POST" action="generate_certificate.php" target="_blank">
          <input type="hidden" name="timestamp" id="formTimestamp" />
          <input type="hidden" name="hash" id="formHash" />
          <input type="hidden" name="serial" id="formSerial" />
          <input type="hidden" name="first_name" id="formFirstName" />
          <input type="hidden" name="last_name" id="formLastName" />
          <input type="hidden" name="email" id="formEmail" />
          <input type="hidden" name="phone" id="formPhone" />
          <input type="hidden" name="file_name" id="formFileName" />
          <button type="submit" class="download-button">üìÑ –ò–∑—Ç–µ–≥–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</button>
        </form>

        <button class="send-button">üì§ –ò–∑–ø—Ä–∞—Ç–∏</button>
      </div>
    </div>
  </section>

  <script src="script.js"></script>
  <script>
    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –æ—Ç –±–∏—Å–∫–≤–∏—Ç–∫–∞ –ø–æ –∏–º–µ
    function getCookie(name) {
      const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return match ? decodeURIComponent(match[2]) : null;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∏–∑–±–æ—Ä–∞ –Ω–∞ —Ñ–∞–π–ª, –µ—Ç–∏–∫–µ—Ç –∑–∞ –º–∞–∫—Å–∏–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä –∏ –∫–∞—á–≤–∞–Ω–µ
    document.addEventListener("DOMContentLoaded", () => {
      const uploadButton = document.getElementById("uploadButton");
      const fileInput = document.getElementById("fileInput");
      const fileNameLabel = document.getElementById("fileName");
      const publicCheckbox = document.getElementById("publicCheckbox");
      const maxFileSizeLabel = document.getElementById("maxFileSizeLabel");

      if (!uploadButton || !fileInput || !fileNameLabel || !publicCheckbox || !maxFileSizeLabel) {
        console.error("‚ùå –õ–∏–ø—Å–≤–∞—Ç –∫–ª—é—á–æ–≤–∏ –µ–ª–µ–º–µ–Ω—Ç–∏.");
        return;
      }

      // –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –µ—Ç–∏–∫–µ—Ç–∞ –∑–∞ –º–∞–∫—Å–∏–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä
      function updateMaxSizeLabel() {
        maxFileSizeLabel.textContent = publicCheckbox.checked ? " (–¥–æ 10 MB)" : " (–¥–æ 20 MB)";
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
      updateMaxSizeLabel();

      // –û–±–Ω–æ–≤—è–≤–∞–Ω–µ –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ —á–µ–∫–±–æ–∫—Å–∞
      publicCheckbox.addEventListener("change", updateMaxSizeLabel);

      // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏–∑–±—Ä–∞–Ω–æ—Ç–æ –∏–º–µ –Ω–∞ —Ñ–∞–π–ª–∞
      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        fileNameLabel.textContent = file ? file.name : "–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω";
      });

      // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –±—É—Ç–æ–Ω–∞ –∑–∞ –∫–∞—á–≤–∞–Ω–µ
      uploadButton.addEventListener("click", uploadFile);
    });

    function uploadFile() {
      const fileInput = document.getElementById("fileInput");
      const publicCheckbox = document.getElementById("publicCheckbox");
      const statusElement = document.getElementById("status");
      const resultBlock = document.getElementById("timestampResult");
      const resultTimestamp = document.getElementById("resultTimestamp");
      const resultHash = document.getElementById("resultHash");
      const resultSerial = document.getElementById("resultSerial");

      if (!fileInput || !fileInput.files.length) {
        setStatus("‚ùå –ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª.", "error");
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—Ç—á–∞—Ç–∞ ‚Äì –∏–∑–ø–æ–ª–∑–≤–∞–º–µ grecaptcha.getResponse(), –∑–∞ –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∞–ª–∏ –µ –ø–æ–ø—ä–ª–Ω–µ–Ω–∞
      const captchaResponse = grecaptcha.getResponse();
      if (!captchaResponse) {
        setStatus("‚ùå –ú–æ–ª—è, –ø–æ—Ç–≤—ä—Ä–¥–µ—Ç–µ, —á–µ –Ω–µ —Å—Ç–µ —Ä–æ–±–æ—Ç.", "error");
        return;
      }

      const file = fileInput.files[0];

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –º–∞–∫—Å–∏–º–∞–ª–µ–Ω —Ä–∞–∑–º–µ—Ä —Å–ø–æ—Ä–µ–¥ –∏–∑–±–æ—Ä–∞ (10 MB –∞–∫–æ –µ –ø—É–±–ª–∏—á–µ–Ω, 20 MB –∞–∫–æ –Ω–µ –µ)
      const maxSizeMB = publicCheckbox.checked ? 10 : 20;
      if (file.size > maxSizeMB * 1024 * 1024) {
        setStatus(`‚ùå –§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–¥ ${maxSizeMB} MB.`, "error");
        return;
      }

      setStatus("‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...", "loading");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("public", publicCheckbox.checked ? 1 : 0);
      // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞ –Ω–∞ reCAPTCHA –∫—ä–º –¥–∞–Ω–Ω–∏—Ç–µ –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ
      formData.append("g-recaptcha-response", captchaResponse);

      fetch("upload.php", {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(raw => {
        try {
          const data = JSON.parse(raw);

          if (data.status === "error") {
            console.warn("‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞:", data.message || data);
            setStatus(`‚ùå ${data.message || "–ì—Ä–µ—à–∫–∞ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞."}`, "error");
            return;
          }

          if (data.status === "exists") {
            setStatus("‚ÑπÔ∏è –§–∞–π–ª—ä—Ç –≤–µ—á–µ –µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω.", "info");
          } else if (data.status === "success") {
            setStatus("‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–æ!", "success");
          } else {
            setStatus("‚ùå –ù–µ–æ—á–∞–∫–≤–∞–Ω —Å—Ç–∞—Ç—É—Å –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞.", "error");
            return;
          }

          // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ
          const timestamp = data.timestamp || "-";
          const hash = data.file_hash || "-";
          const serial = data.serial_number || "-";

          resultTimestamp.textContent = timestamp;
          resultHash.textContent = hash;
          resultSerial.textContent = serial;

          resultBlock.classList.remove("hidden");

          // –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏—Ç–∏—Ç–µ –ø–æ–ª–µ—Ç–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å –¥–∞–Ω–Ω–∏—Ç–µ –Ω–∞ —Ç–µ–∫—É—â–∏—è –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª
          fillCertificateForm(timestamp, hash, serial);

          // –ù—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ reCAPTCHA (–ø–æ –∂–µ–ª–∞–Ω–∏–µ)
          grecaptcha.reset();

        } catch (err) {
          console.error("‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ç–∞ –Ω–∞ JSON:", err);
          console.log("Raw server response:", raw);
          setStatus("‚ùå –ù–µ–æ—á–∞–∫–≤–∞–Ω –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞.", "error");
        }
      })
      .catch(err => {
        console.error("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—è–≤–∫–∞—Ç–∞:", err);
        setStatus("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—è–≤–∫–∞—Ç–∞.", "error");
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞–¥–∞–≤–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ —Å—ä—Å —Å—ä–æ—Ç–≤–µ—Ç–Ω–∏—è —Ç–∏–ø
    function setStatus(msg, type = "info") {
      const status = document.getElementById("status");
      if (!status) return;
      status.textContent = msg;
      status.className = type;
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏—Ç–∏—Ç–µ –ø–æ–ª–µ—Ç–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
    // –î–∞–Ω–Ω–∏—Ç–µ —Å–µ –∏–∑–≤–ª–∏—á–∞—Ç –¥–∏–Ω–∞–º–∏—á–Ω–æ –æ—Ç –±–∏—Å–∫–≤–∏—Ç–∫–∏ –∏ –µ–ª–µ–º–µ–Ω—Ç–∞ –∑–∞ –∏–º–µ –Ω–∞ —Ñ–∞–π–ª
    function fillCertificateForm(timestamp, hash, serial) {
      console.log("üìÑ –ü–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–Ω–∏—Ç–µ –ø–æ–ª–µ—Ç–∞:", { timestamp, hash, serial });
      document.getElementById("formTimestamp").value = timestamp;
      document.getElementById("formHash").value = hash;
      document.getElementById("formSerial").value = serial;
      
      // –ò–∑–ø–æ–ª–∑–≤–∞–º–µ —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞ getCookie –∑–∞ –¥–∏–Ω–∞–º–∏—á–Ω–æ –≤–∑–µ–º–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
      const firstName = getCookie("first_name") || "";
      const lastName = getCookie("last_name") || "";
      const email = getCookie("email") || "";
      const phone = getCookie("phone") || "";
      
      document.getElementById("formFirstName").value = firstName;
      document.getElementById("formLastName").value = lastName;
      document.getElementById("formEmail").value = email;
      document.getElementById("formPhone").value = phone;
      
      // –í–∑–µ–º–∞–Ω–µ –Ω–∞ –∏–º–µ—Ç–æ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—è —Ñ–∞–π–ª –æ—Ç –µ–ª–µ–º–µ–Ω—Ç–∞ fileName
      document.getElementById("formFileName").value = document.getElementById("fileName").textContent;
    }
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      function getCookie(name) {
        const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
        return match ? decodeURIComponent(match[2]) : null;
      }

      const loggedIn = getCookie("loggedin") === "1";
      const firstName = getCookie("first_name");
      const lastName = getCookie("last_name");
      const fallbackUsername = getCookie("username");
      const toggle = document.getElementById("dropdownToggle");
      const menu = document.getElementById("dropdownMenu");

      if (!toggle || !menu) return;

      if (loggedIn && firstName && lastName) {
        toggle.innerHTML = `–ó–¥—Ä–∞–≤–µ–π, ${firstName} ${lastName} ‚ñæ`;
        menu.innerHTML = `
          <a href="account.php">–ú–æ—è—Ç –ø—Ä–æ—Ñ–∏–ª</a>
          <a href="logout.php">–ò–∑—Ö–æ–¥</a>
        `;
      } else if (loggedIn && fallbackUsername) {
        toggle.innerHTML = `–ó–¥—Ä–∞–≤–µ–π, ${fallbackUsername} ‚ñæ`;
        menu.innerHTML = `
          <a href="account.php">–ú–æ—è—Ç –ø—Ä–æ—Ñ–∏–ª</a>
          <a href="logout.php">–ò–∑—Ö–æ–¥</a>
        `;
      } else {
        toggle.innerHTML = "–ê–∫–∞—É–Ω—Ç ‚ñæ";
        menu.innerHTML = `
          <a href="login.html">–í—Ö–æ–¥</a>
          <a href="signup.html">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        `;
      }

      toggle.addEventListener("click", (e) => {
        e.stopPropagation();
        menu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("userDropdown");
        if (!dropdown.contains(e.target)) {
          menu.classList.remove("show");
        }
      });
    });
  </script>
</body>

</html>
