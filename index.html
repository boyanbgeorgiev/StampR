<!DOCTYPE html>
<html lang="bg">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StampR ‚Äì –í—Ä–µ–º–µ–≤–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è–≤–∞–Ω–µ</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Navigation -->
  <header class="header">
    <nav class="nav">
      <a href="/index.html"><button  class="active">–í—Ä–µ–º–µ–≤–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è–≤–∞–Ω–µ</button></a>
      <a href="/hash_search.html"><button>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª</button></a>
      <a href="about.html"><button>–ó–∞ –Ω–∞—Å</button></a> <!-- Link to About page -->

      <div class="dropdown" id="userDropdown">
        <button id="dropdownToggle">üë§ –ê–∫–∞—É–Ω—Ç ‚ñæ</button>
        <div class="dropdown-menu" id="dropdownMenu">
          <!-- JS injects menu -->
        </div>
      </div>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-text">
      <h1>StampR</h1>
      <p>–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —É—Å–ª—É–≥–∞—Ç–∞. –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —É—Å–ª—É–≥–∞—Ç–∞.</p>
    </div>
    <div class="hero-icon">
      <img src="timestamp.svg" alt="–ò–∫–æ–Ω–∞ –Ω–∞ –ø–µ—á–∞—Ç" />
    </div>
  </section>

  <!-- Upload Section -->
  <section class="upload-section">
    <h2><span class="emoji">üßæ</span> –í—Ä–µ–º–µ–≤–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è–≤–∞–Ω–µ</h2>
    <div class="layout-wrapper">
      <div class="upload-card justify-center">
        <div class="upload-box original" data-label="–û—Ä–∏–≥–∏–Ω–∞–ª">
          <div class="file-input-wrapper">
            <label for="fileInput">–ö–∞—á–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª</label>
            <span id="fileName">–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω</span>
            <input type="file" id="fileInput" />
          </div>

          <!-- Checkbox for public visibility -->
          <label>
            <input type="checkbox" id="publicCheckbox" /> –ó–∞–ø–∞–∑–∏ –∑–∞ –ø—É–±–ª–∏—á–Ω–æ –ø–æ–∫–∞–∑–≤–∞–Ω–µ
          </label>

          <button id="uploadButton">–£–¥–æ—Å—Ç–æ–≤–µ—Ä–∏</button>
        </div>
      </div>

      <!-- Status -->
      <div id="status" class="status-info"></div>

      <!-- Result -->
      <div id="timestampResult" class="result-card hidden">
        <h3>–†–µ–∑—É–ª—Ç–∞—Ç</h3>
        <div class="result-row">
          <label>Timestamp</label>
          <div class="result-value copy-wrap">
            <span id="resultTimestamp"></span>
            <button class="copy-btn" data-copy="resultTimestamp" title="–ö–æ–ø–∏—Ä–∞–π">üìã</button>
          </div>
        </div>

        <div class="result-row">
          <label>HASH number</label>
          <div class="result-value copy-wrap">
            <span id="resultHash" class="mono"></span>
            <button class="copy-btn" data-copy="resultHash" title="–ö–æ–ø–∏—Ä–∞–π">üìã</button>
          </div>
        </div>

        <div class="result-row">
          <label>Serial number</label>
          <div class="result-value copy-wrap">
            <span id="resultSerial"></span>
            <button class="copy-btn" data-copy="resultSerial" title="–ö–æ–ø–∏—Ä–∞–π">üìã</button>
          </div>
        </div>

        <form method="POST" action="generate_certificate.php" target="_blank">
          <input type="hidden" name="timestamp" id="formTimestamp" />
          <input type="hidden" name="hash" id="formHash" />
          <input type="hidden" name="serial" id="formSerial" />
          <button type="submit" class="download-button">üìÑ –ò–∑—Ç–µ–≥–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</button>
        </form>

        <button class="send-button">üì§ –ò–∑–ø—Ä–∞—Ç–∏</button>
      </div>
    </div>
  </section>

  <script src="script.js"></script>
  <script>
    // File upload with size limit
    document.addEventListener("DOMContentLoaded", () => {
      const uploadButton = document.getElementById("uploadButton");
      const fileInput = document.getElementById("fileInput");
      const fileNameLabel = document.getElementById("fileName");

      if (!uploadButton || !fileInput || !fileNameLabel) {
        console.error("‚ùå Missing key elements.");
        return;
      }

      // Show selected file name
      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        fileNameLabel.textContent = file ? file.name : "–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω";
      });

      // Upload file
      uploadButton.addEventListener("click", uploadFile);
    });

    function uploadFile() {
      const fileInput = document.getElementById("fileInput");
      const publicCheckbox = document.getElementById("publicCheckbox");
      const statusElement = document.getElementById("status");
      const resultBlock = document.getElementById("timestampResult");
      const resultTimestamp = document.getElementById("resultTimestamp");
      const resultHash = document.getElementById("resultHash");
      const resultSerial = document.getElementById("resultSerial");

      if (!fileInput || !fileInput.files.length) {
        setStatus("‚ùå –ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª.", "error");
        return;
      }

      const file = fileInput.files[0];

      // Max size check based on checkbox
      const maxSizeMB = publicCheckbox.checked ? 10 : 20; // 10MB if public, 20MB otherwise
      if (file.size > maxSizeMB * 1024 * 1024) {
        setStatus(`‚ùå –§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–¥ ${maxSizeMB} MB.`, "error");
        return;
      }

      setStatus("‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...", "loading");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("public", publicCheckbox.checked ? 1 : 0); // Add public field to form data

      fetch("upload.php", {
        method: "POST",
        body: formData
      })
        .then(res => res.text())
        .then(raw => {
          try {
            const data = JSON.parse(raw);

            if (data.status === "error") {
              console.warn("‚ö†Ô∏è Server error:", data.message || data);
              setStatus(`‚ùå ${data.message || "–ì—Ä–µ—à–∫–∞ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞."}`, "error");
              return;
            }

            if (data.status === "exists") {
              setStatus("‚ÑπÔ∏è –§–∞–π–ª—ä—Ç –≤–µ—á–µ –µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω.", "info");
            } else if (data.status === "success") {
              setStatus("‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–æ!", "success");
            } else {
              setStatus("‚ùå –ù–µ–æ—á–∞–∫–≤–∞–Ω —Å—Ç–∞—Ç—É—Å –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞.", "error");
              return;
            }

            // Populate result
            const timestamp = data.timestamp || "-";
            const hash = data.file_hash || "-";
            const serial = data.serial_number || "-";

            resultTimestamp.textContent = timestamp;
            resultHash.textContent = hash;
            resultSerial.textContent = serial;

            resultBlock.classList.remove("hidden");

            // ‚úÖ Fill hidden form fields for PDF generation
            fillCertificateForm(timestamp, hash, serial);

          } catch (err) {
            console.error("‚ö†Ô∏è JSON parse error:", err);
            console.log("Raw server response:", raw);
            setStatus("‚ùå –ù–µ–æ—á–∞–∫–≤–∞–Ω –æ—Ç–≥–æ–≤–æ—Ä –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞.", "error");
          }
        })
        .catch(err => {
          console.error("‚ùå Fetch/network error:", err);
          setStatus("‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—è–≤–∫–∞—Ç–∞.", "error");
        });
    }

    // Utility: show message with type
    function setStatus(msg, type = "info") {
      const status = document.getElementById("status");
      if (!status) return;
      status.textContent = msg;
      status.className = type;
    }

    // ‚úÖ Utility: Fill hidden form for certificate generation
    function fillCertificateForm(timestamp, hash, serial) {
      console.log("üìÑ Updating form fields:", { timestamp, hash, serial });
      document.getElementById("formTimestamp").value = timestamp;
      document.getElementById("formHash").value = hash;
      document.getElementById("formSerial").value = serial;
    }
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      function getCookie(name) {
        const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
        return match ? decodeURIComponent(match[2]) : null;
      }

      const loggedIn = getCookie("loggedin") === "1";
      const username = getCookie("username");
      const toggle = document.getElementById("dropdownToggle");
      const menu = document.getElementById("dropdownMenu");

      if (!toggle || !menu) return;

      if (loggedIn && username) {
        toggle.innerHTML = `–ó–¥—Ä–∞–≤–µ–π, ${username} ‚ñæ`;
        menu.innerHTML = `
          <a href="account.php">–ú–æ—è—Ç –ø—Ä–æ—Ñ–∏–ª</a>
          <a href="logout.php">–ò–∑—Ö–æ–¥</a>
        `;
      } else {
        toggle.innerHTML = "–ê–∫–∞—É–Ω—Ç ‚ñæ";
        menu.innerHTML = `
          <a href="login.html">–í—Ö–æ–¥</a>
          <a href="signup.html">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        `;
      }

      toggle.addEventListener("click", (e) => {
        e.stopPropagation();
        menu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("userDropdown");
        if (!dropdown.contains(e.target)) {
          menu.classList.remove("show");
        }
      });
    });
  </script>
</body>

</html>
